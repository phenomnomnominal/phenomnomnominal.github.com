<!DOCTYPE html>  <html> <head>   <title>clouds.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               clouds.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h3><em><a href="http://phenomnomnominal.github.com">WebGL + CA Dynamic Clouds</a></em></h3>

<p><em>clouds.coffee</em> contains the implementation of a Cellular Automata for generating a simulation of clouds, using WebGL &amp; <strong><a href="http://mrdoob.github.com/three.js/">three.js</a></strong> for the graphics. The cellular automata used is described in <strong><a href="./A Simple, Efficient Method for Realistic Animation of Clouds.pdf">A Simple, Efficient Method for Realistic Animation of Clouds</a></strong> by Dobashi, Kaneda, Yamashita, Okita &amp; Nishita.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Simulation Constants:</h1>

<hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <ul>
<li><strong><code>START_TIME</code></strong> - The time when the simulation is loaded is used as the starting time for camera position.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">START_TIME = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <ul>
<li><strong><code>P_EXT</code></strong> - The probability that a cloud cell will randomly become extinct in the next generation.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">P_EXT = </span><span class="mf">0.1</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <ul>
<li><strong><code>P_ACT</code></strong> - The probability that a cloud cell will randomlybecome activated in the next generation.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">P_ACT = </span><span class="mf">0.01</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <ul>
<li><strong><code>P_HUM</code></strong> - The probability that a cloud cell will randomly become humid in the next generation.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">P_HUM = </span><span class="mf">0.1</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <ul>
<li><strong><code>WIND_SPEED</code></strong> - The maximum amount that a cell can move in one generation due to wind.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">WIND_SPEED = </span><span class="mi">5</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <ul>
<li><strong><code>GENERATION_LENGTH</code></strong> - The number of interpolation points between subsequent generations of the CA.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">GENERATION_LENGTH = </span><span class="mi">1000</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <ul>
<li><strong><code>SMOOTH</code></strong> - A smoothing factor in each the <em>X</em>, <em>Y</em> &amp; <em>Z</em> directions for the conversion from a binary distribution to a continuous distribution.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">SMOOTH =</span>
  <span class="nv">X: </span><span class="mi">2</span>
  <span class="nv">Y: </span><span class="mi">2</span>
  <span class="nv">Z: </span><span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <ul>
<li><strong><code>MAX_WEIGHT</code></strong> - The maximum smoothing weighting that a cell can possibly have, for when a cloud cell is completely surrounded by other cloud cells. Used to normalisation the CDF.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">MAX_WEIGHT = </span><span class="mi">0</span>
<span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="o">-</span><span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">X</span><span class="p">..</span><span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">X</span><span class="p">]</span>
  <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="o">-</span><span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Y</span><span class="p">..</span><span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Y</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="p">[</span><span class="o">-</span><span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Z</span><span class="p">..</span><span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Z</span><span class="p">]</span>
      <span class="nx">MAX_WEIGHT</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">((</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">z</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h1>Rendering Constants:</h1>

<hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <ul>
<li><strong><code>RENDERER</code></strong> - The <strong><a href="http://mrdoob.github.com/three.js/">three.js</a></strong> <strong><code>WebGLRenderer</code></strong></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">RENDERER = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderer</span><span class="p">(</span><span class="nv">antialias: </span><span class="kc">no</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <ul>
<li><strong><code>SCENE</code></strong> - The <strong><a href="http://mrdoob.github.com/three.js/">three.js</a></strong> <strong><code>Scene</code></strong></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">SCENE = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Scene</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <ul>
<li><strong><code>CAMERA</code></strong> - The <strong><a href="http://mrdoob.github.com/three.js/">three.js</a></strong> <strong><code>PerspectiveCamera</code></strong></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">CAMERA = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PerspectiveCamera</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">innerWidth</span><span class="p">()</span> <span class="o">/</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">innerHeight</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2450</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <ul>
<li><strong><code>Z_POS</code></strong> - The <strong><code>CAMERA</code></strong>s position on the <em>Z</em> axis.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Z_POS = </span><span class="mi">3000</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h1>Utility Functions:</h1>

<hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <blockquote>
  <h2>Lerp:</h2>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <blockquote>
  <p><strong><code>Lerp</code></strong> performs linear interpolation by a factor <code>s</code> between two values: <code>x</code> and <code>y</code></p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Lerp = </span><span class="nf">(x, y, s) -&gt;</span>
  <span class="nx">x</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">s</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">s</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h1><section id='c'>Clouds:</section></h1>

<hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <blockquote>
  <p>The main <strong><code>Clouds</code></strong> function initialises the running of the simulation.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Clouds = </span><span class="o">-&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <blockquote>
  <h2>Renderer Initialisation:</h2>
  
  <hr />
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>First, the <strong><code>RENDERER</code></strong> is set to the size of the whole <code>window</code> and added to the DOM.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">RENDERER</span><span class="p">.</span><span class="nx">setSize</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">innerWidth</span><span class="p">(),</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">innerHeight</span><span class="p">()</span>
  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;.clouds div&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">RENDERER</span><span class="p">.</span><span class="nx">domElement</span>
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>Then a <code>window</code> resize handler is added which updates the <strong><code>RENDERER</code></strong> and the <strong><code>CAMERA</code></strong> to the <code>window</code> size.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span> <span class="o">-&gt;</span>
    <span class="nv">CAMERA.aspect = </span><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">innerWidth</span><span class="p">()</span> <span class="o">/</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">innerHeight</span><span class="p">()</span>
    <span class="nx">CAMERA</span><span class="p">.</span><span class="nx">updateProjectionMatrix</span><span class="p">()</span>
    <span class="nx">RENDERER</span><span class="p">.</span><span class="nx">setSize</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">innerWidth</span><span class="p">(),</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">innerHeight</span><span class="p">()</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">trigger</span> <span class="s">&#39;resize&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>Then the <strong><code>CAMERA</code></strong> position in the <strong><code>SCENE</code></strong> is set, and the <strong><code>CAMERA</code></strong> object is added to the <strong><code>SCENE</code></strong>.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">CAMERA.position.y = </span><span class="mi">190</span>
  <span class="nv">CAMERA.position.z = </span><span class="nx">Z_POS</span>
  <span class="nx">SCENE</span><span class="p">.</span><span class="nx">add</span> <span class="nx">CAMERA</span>
  </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>Lastly, the two different materials that are used for the clouds are loaded from images and initialised.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">materials = </span><span class="o">-&gt;</span>
    <span class="nv">vs = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#vs&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>
    <span class="nv">fs = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#fs&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>

    <span class="nv">fog = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Fog</span><span class="p">(</span><span class="mh">0x2F222F</span><span class="p">,</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">m</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">texture = </span><span class="nx">THREE</span><span class="p">.</span><span class="nx">ImageUtils</span><span class="p">.</span><span class="nx">loadTexture</span> <span class="s">&quot;images/cloud</span><span class="si">#{</span><span class="nx">m</span><span class="si">}</span><span class="s">.png&quot;</span>
      <span class="nv">texture.magFilter = </span><span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearMipMapLinearFilter</span>
      <span class="nv">texture.minFilter = </span><span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearMipMapLinearFilter</span>
      
      <span class="nv">u = </span>
        <span class="s">&#39;map&#39;</span><span class="o">:</span> <span class="nv">type: </span><span class="s">&#39;t&#39;</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">texture</span>
        <span class="s">&#39;fogColor&#39;</span><span class="o">:</span> <span class="nv">type: </span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">fog</span><span class="p">.</span><span class="nx">color</span>
        <span class="s">&#39;fogNear&#39;</span><span class="o">:</span> <span class="nv">type: </span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">fog</span><span class="p">.</span><span class="nx">near</span>
        <span class="s">&#39;fogFar&#39;</span><span class="o">:</span> <span class="nv">type: </span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">fog</span><span class="p">.</span><span class="nx">far</span>
      
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderMaterial</span><span class="p">(</span><span class="nv">uniforms: </span><span class="nx">u</span><span class="p">,</span> <span class="nv">vertexShader: </span><span class="nx">vs</span><span class="p">,</span> <span class="nv">fragmentShader: </span><span class="nx">fs</span><span class="p">,</span> <span class="nv">depthWrite: </span><span class="kc">no</span><span class="p">)</span>
  <span class="nv">materials = </span><span class="nx">materials</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <blockquote>
  <h2>Simulation Initialisation:</h2>
  
  <hr />
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>A new <strong><a href="#ca"><code>CloudCA</code></a></strong> is created with <code>4096</code> cells,</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clouds = </span><span class="k">new</span> <span class="nx">CloudCA</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>some placeholder variables are initialised,</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">groupFront = </span><span class="kc">null</span>
  <span class="nv">groupBack = </span><span class="kc">null</span>
  <span class="nv">positions = </span><span class="p">[]</span>
  <span class="nv">rotations = </span><span class="p">[]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>and the simulation is started!</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <blockquote>
  <h2>simulate:</h2>
  
  <hr />
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>The <strong><code>simulate</code></strong> function performs the majority of the work. It is responsible for requesting the next generation from the CA and then interpolating between the values from the generations. It is also responsible for initialising and updating the <strong><a href="http://mrdoob.github.com/three.js/">three.js</a></strong> geometry for the drawn clouds.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">(</span><span class="nv">simulate = </span><span class="o">-&gt;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>The first time simulate is called, the geometric objects which hold the clouds must be initialised. Two identical sets of geometry are maintained, one with a negative <em>Z</em> axis offset. This allows there to be a continuous stream of clouds with no gaps. The two objects <strong><code>groupFront</code></strong> and <strong><code>groupBack</code></strong> are added to the <strong><code>SCENE</code></strong>.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">gen</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nv">groupFront = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">()</span>
      <span class="nv">groupBack = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">()</span>
      <span class="nx">SCENE</span><span class="p">.</span><span class="nx">add</span> <span class="nx">groupFront</span>
      <span class="nx">SCENE</span><span class="p">.</span><span class="nx">add</span> <span class="nx">groupBack</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>The 3D Cellular Automata that generates the cloud structure is reasonably expensive to generate. To balance this, a new generation of the CA is only created after a number of frames have passed.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">gen</span> <span class="o">%</span> <span class="nx">GENERATION_LENGTH</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nv">cloudDensity = </span><span class="nx">clouds</span><span class="p">.</span><span class="nx">getGeneration</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>However, on every single frame, each cell in the 3D <strong><code>SCENE</code></strong> can be updated smootly, by interpolating between the data provided by subsequent generations of the CA.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">i = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">clouds</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">clouds</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">clouds</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">]</span>
          </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>The first time through, all the individual <strong><code>PlaneGeometry</code></strong> which form the cloud billboards must be initialised, and added to the <strong><code>groupFront</code></strong> and <strong><code>groupBack</code></strong>. Their positions and rotations are slightly randomised to increase the realism of the result.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">gen</span> <span class="o">is</span> <span class="mi">0</span>
            <span class="nv">planeFront = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="nx">materials</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nv">planeFront.position.x = </span><span class="mi">100000</span>
            <span class="nv">planeBack = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="nx">materials</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nv">planeBack.position.x = </span><span class="mi">100000</span>
            <span class="nx">positions</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span>
            <span class="nx">rotations</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> 
              <span class="nv">initial: </span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span>
              <span class="nv">increment: </span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">2000</span>
            <span class="nx">groupFront</span><span class="p">.</span><span class="nx">add</span> <span class="nx">planeFront</span>
            <span class="nx">groupBack</span><span class="p">.</span><span class="nx">add</span> <span class="nx">planeBack</span>
          </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>Then the size of each <strong><code>PlaneGeometry</code></strong> is generated by performing a linear interpolation between the generations of the CA.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">scale = </span><span class="nx">Lerp</span><span class="p">(</span><span class="nx">clouds</span><span class="p">.</span><span class="nx">density</span><span class="p">.</span><span class="nx">current</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">],</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">density</span><span class="p">.</span><span class="nx">next</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">],</span> <span class="p">(</span><span class="nx">clouds</span><span class="p">.</span><span class="nx">gen</span> <span class="o">%</span> <span class="nx">GENERATION_LENGTH</span><span class="p">)</span> <span class="o">/</span> <span class="nx">GENERATION_LENGTH</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>If the part of the cloud will be visible, the corresponding <strong><code>PlaneGeometry</code></strong> in both the <strong><code>groupFront</code></strong> and <strong><code>groupBack</code></strong> are updated.</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">scale</span> <span class="o">isnt</span> <span class="mi">0</span>
            <span class="nv">planeFront = </span><span class="nx">groupFront</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
            <span class="nv">planeBack = </span><span class="nx">groupBack</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nx">scale</span> <span class="o">&lt;</span> <span class="mf">0.1</span>
              <span class="nv">planeFront.material = </span><span class="nx">materials</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
              <span class="nv">planeBack.material = </span><span class="nx">materials</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="nv">planeFront.position = </span><span class="nx">positions</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
            <span class="nv">planeBack.position = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="nx">positions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="nx">positions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="nx">positions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">Z_POS</span><span class="p">)</span>
            <span class="nv">planeFront.rotation.z = </span><span class="nx">rotations</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">initial</span> <span class="o">+</span> <span class="p">(</span><span class="nx">rotations</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">increment</span> <span class="o">*</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">gen</span><span class="p">)</span>
            <span class="nv">planeBack.rotation.z = </span><span class="nx">rotations</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">initial</span> <span class="o">+</span> <span class="p">(</span><span class="nx">rotations</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">increment</span> <span class="o">*</span> <span class="nx">clouds</span><span class="p">.</span><span class="nx">gen</span><span class="p">)</span>
            <span class="nv">planeFront.scale.x = planeFront.scale.y = </span><span class="nx">scale</span>
            <span class="nv">planeBack.scale.x = planeBack.scale.y = </span><span class="nx">scale</span>
          <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span>
    </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <blockquote>
  <blockquote>
    <p>The generation count is incremented, the <strong><code>CAMERA</code></strong> position is updated, the <strong><code>RENDERER</code></strong> renders the <strong><code>SCENE</code></strong> and the <strong><code>simulate</code></strong> function is called again</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">clouds</span><span class="p">.</span><span class="nx">gen</span><span class="o">++</span>
    <span class="nv">CAMERA.position.z = </span><span class="o">-</span><span class="p">(((</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">START_TIME</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.03</span><span class="p">)</span> <span class="o">%</span> <span class="nx">Z_POS</span><span class="p">)</span> <span class="o">+</span> <span class="nx">Z_POS</span>
    <span class="nx">RENDERER</span><span class="p">.</span><span class="nx">render</span> <span class="nx">SCENE</span><span class="p">,</span> <span class="nx">CAMERA</span>
    <span class="nx">requestAnimFrame</span> <span class="nx">simulate</span>
  <span class="p">)()</span>

<span class="k">class</span> <span class="nx">CloudCA</span>
  <span class="nv">constructor: </span><span class="nf">(@x, @y, @z, @interpolate = 1, @gen = 0) -&gt;</span>
    
    <span class="vi">@positions = </span><span class="nx">createPositions</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span>
    <span class="vi">@density = </span><span class="nv">curr: </span><span class="kc">null</span><span class="p">,</span> <span class="nv">next: </span><span class="kc">null</span>
    <span class="vi">@size = </span><span class="nx">@x</span> <span class="o">*</span> <span class="nx">@y</span> <span class="o">*</span> <span class="nx">@z</span>

    <span class="vi">@_ =</span>
      <span class="nv">gen:</span>
        <span class="nv">hum: </span><span class="p">((</span><span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">then</span> <span class="s">&#39;1&#39;</span> <span class="k">else</span> <span class="s">&#39;0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@size</span><span class="p">]).</span><span class="nx">join</span> <span class="s">&#39;&#39;</span>
        <span class="nv">act: </span><span class="p">((</span><span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">then</span> <span class="s">&#39;1&#39;</span> <span class="k">else</span> <span class="s">&#39;0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@size</span><span class="p">]).</span><span class="nx">join</span> <span class="s">&#39;&#39;</span>
        <span class="nv">cld: </span><span class="p">(</span><span class="s">&#39;0&#39;</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@size</span><span class="p">]).</span><span class="nx">join</span> <span class="s">&#39;&#39;</span>
    
    <span class="vi">@_.clouds = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nf">(x, y, z) -&gt;</span> <span class="o">+</span><span class="nx">@_</span><span class="p">.</span><span class="nx">gen</span><span class="p">.</span><span class="nx">cld</span><span class="p">[</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">@x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">@y</span> <span class="o">+</span> <span class="nx">z</span><span class="p">])</span>
    <span class="vi">@density.next = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nf">(x, y, z) -&gt;</span> <span class="nx">getDensity</span><span class="p">(</span><span class="nx">@_</span><span class="p">.</span><span class="nx">clouds</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">))</span>
    <span class="nx">@getGeneration</span><span class="p">()</span>

  <span class="nv">createPositions = </span><span class="o">-&gt;</span>
    <span class="nv">min = x: </span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="nv">y: </span><span class="mi">50</span><span class="p">,</span> <span class="nv">z: </span><span class="mi">0</span>
    <span class="nv">max = x: </span><span class="mi">500</span><span class="p">,</span> <span class="nv">y: </span><span class="mi">200</span><span class="p">,</span> <span class="nv">z: </span><span class="mi">3000</span>
    <span class="nv">d =</span>
      <span class="nv">x: </span><span class="p">(</span><span class="nx">max</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">min</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="nx">@x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">)</span>
      <span class="nv">y: </span><span class="p">(</span><span class="nx">max</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">min</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="nx">@y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">)</span>
      <span class="nv">z: </span><span class="p">(</span><span class="nx">max</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">min</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="nx">@z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">@x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">@y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">@z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">]</span>
          <span class="nv">rand = </span><span class="p">{}</span>
          <span class="nx">rand</span><span class="p">[</span><span class="nx">dim</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">d</span><span class="p">[</span><span class="nx">dim</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">dim</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="nx">dim</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">]</span>
          <span class="nv">pos = </span>
            <span class="nv">x: </span><span class="nx">min</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">+</span> <span class="nx">rand</span><span class="p">.</span><span class="nx">x</span>
            <span class="nv">y: </span><span class="nx">min</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">+</span> <span class="nx">rand</span><span class="p">.</span><span class="nx">y</span>
            <span class="nv">z: </span><span class="nx">min</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="p">(</span><span class="nx">z</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">+</span> <span class="nx">rand</span><span class="p">.</span><span class="nx">z</span>
          <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span>

  <span class="nv">getGeneration: </span><span class="o">-&gt;</span>
    <span class="vi">@_.gen = </span><span class="nx">process</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@_</span><span class="p">.</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">growth</span><span class="p">)</span>
    <span class="vi">@_.gen = </span><span class="nx">process</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@_</span><span class="p">.</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">extinction</span><span class="p">)</span>
    <span class="vi">@_.gen = </span><span class="nx">process</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@_</span><span class="p">.</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">wind</span><span class="p">)</span>
    <span class="vi">@_.clouds = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nf">(x, y, z) -&gt;</span> <span class="o">+</span><span class="nx">@_</span><span class="p">.</span><span class="nx">gen</span><span class="p">.</span><span class="nx">cld</span><span class="p">[</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">@x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">@y</span> <span class="o">+</span> <span class="nx">z</span><span class="p">]))</span>
    <span class="vi">@density =</span>
      <span class="nv">current: </span><span class="nx">@density</span><span class="p">.</span><span class="nx">next</span>
      <span class="nv">next: </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nf">(x, y, z) -&gt;</span> <span class="nx">getDensity</span><span class="p">(</span><span class="nx">@_</span><span class="p">.</span><span class="nx">clouds</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nx">@interpolate</span> <span class="o">isnt</span> <span class="mi">1</span>
      <span class="vi">@density.next = </span><span class="nx">trilinear</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@density</span><span class="p">.</span><span class="nx">next</span>
    <span class="nx">@density</span>

  <span class="nv">logic =</span>
    <span class="o">and:</span> <span class="nf">(str1, str2, res = &#39;&#39;) -&gt;</span>
      <span class="p">(</span><span class="nx">res</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">str1</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="nx">str2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">str1</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nx">res</span>
    <span class="o">or:</span> <span class="nf">(str1, str2, res = &#39;&#39;) -&gt;</span>
      <span class="p">(</span><span class="nx">res</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">str1</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">|</span> <span class="nx">str2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">str1</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nx">res</span>
    <span class="o">not:</span> <span class="nf">(str, res = &#39;&#39;) -&gt;</span>
      <span class="p">(</span><span class="nx">res</span> <span class="o">+=</span> <span class="k">if</span> <span class="nx">str</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;0&#39;</span> <span class="k">then</span> <span class="s">&#39;1&#39;</span> <span class="k">else</span> <span class="s">&#39;0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nx">res</span>

  <span class="nv">toGrid = </span><span class="nf">(func) -&gt;</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@x</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@y</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@z</span><span class="p">]</span>
          <span class="nx">func</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">)</span>
          
  <span class="nv">trilinear = </span><span class="nf">(grid) -&gt;</span>
    <span class="nv">interpolated = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..(</span><span class="nx">@x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">]</span>
      <span class="nx">interpolated</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..(</span><span class="nx">@y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">]</span>
        <span class="nx">interpolated</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..(</span><span class="nx">@z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">]</span>
          <span class="nv">origX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">@interpolate</span><span class="p">)</span>
          <span class="nv">origY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">@interpolate</span><span class="p">)</span>
          <span class="nv">origZ = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">z</span> <span class="o">/</span> <span class="nx">@interpolate</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">x</span> <span class="o">%</span> <span class="nx">@interpolate</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">y</span> <span class="o">%</span> <span class="nx">@interpolate</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">z</span> <span class="o">%</span> <span class="nx">@interpolate</span> <span class="o">is</span> <span class="mi">0</span>
            <span class="nx">interpolated</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">origX</span><span class="p">][</span><span class="nx">origY</span><span class="p">][</span><span class="nx">origZ</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..(</span><span class="nx">@x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..(</span><span class="nx">@y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..(</span><span class="nx">@z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">]</span>
          <span class="nx">unless</span> <span class="nx">interpolated</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span><span class="o">?</span>
            <span class="nv">prevX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">@interpolate</span><span class="p">)</span>
            <span class="nv">prevY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">@interpolate</span><span class="p">)</span>
            <span class="nv">prevZ = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">z</span> <span class="o">/</span> <span class="nx">@interpolate</span><span class="p">)</span>
            <span class="nv">nextX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">prevX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">@x</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="nv">nextY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">prevY</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">@y</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="nv">nextZ = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">prevZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">@z</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="nv">xd = </span><span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="p">(</span><span class="nx">prevX</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="nx">nextX</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">prevX</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">))</span>
            <span class="nv">yd = </span><span class="p">(</span><span class="nx">y</span> <span class="o">-</span> <span class="p">(</span><span class="nx">prevY</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="nx">nextY</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">prevY</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">))</span>
            <span class="nv">zd = </span><span class="p">(</span><span class="nx">z</span> <span class="o">-</span> <span class="p">(</span><span class="nx">prevZ</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="nx">nextZ</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">prevZ</span> <span class="o">*</span> <span class="nx">@interpolate</span><span class="p">))</span>
            <span class="nv">c00 = </span><span class="k">if</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">xd</span><span class="p">)</span> <span class="k">then</span> <span class="nx">Lerp</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">prevX</span><span class="p">][</span><span class="nx">prevY</span><span class="p">][</span><span class="nx">prevZ</span><span class="p">],</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">nextX</span><span class="p">][</span><span class="nx">prevY</span><span class="p">][</span><span class="nx">prevZ</span><span class="p">],</span> <span class="nx">xd</span> <span class="k">else</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">prevX</span><span class="p">][</span><span class="nx">prevY</span><span class="p">][</span><span class="nx">prevZ</span><span class="p">]</span>
            <span class="nv">c10 = </span><span class="k">if</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">xd</span><span class="p">)</span> <span class="k">then</span> <span class="nx">Lerp</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">prevX</span><span class="p">][</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">prevZ</span><span class="p">],</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">nextX</span><span class="p">][</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">prevZ</span><span class="p">],</span> <span class="nx">xd</span> <span class="k">else</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">prevX</span><span class="p">][</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">prevZ</span><span class="p">]</span>
            <span class="nv">c01 = </span><span class="k">if</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">xd</span><span class="p">)</span> <span class="k">then</span> <span class="nx">Lerp</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">prevX</span><span class="p">][</span><span class="nx">prevY</span><span class="p">][</span><span class="nx">nextZ</span><span class="p">],</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">nextX</span><span class="p">][</span><span class="nx">prevY</span><span class="p">][</span><span class="nx">nextZ</span><span class="p">],</span> <span class="nx">xd</span> <span class="k">else</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">prevX</span><span class="p">][</span><span class="nx">prevY</span><span class="p">][</span><span class="nx">nextZ</span><span class="p">]</span>
            <span class="nv">c11 = </span><span class="k">if</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">xd</span><span class="p">)</span> <span class="k">then</span> <span class="nx">Lerp</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">prevX</span><span class="p">][</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">nextZ</span><span class="p">],</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">nextX</span><span class="p">][</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">nextZ</span><span class="p">],</span> <span class="nx">xd</span> <span class="k">else</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">prevX</span><span class="p">][</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">nextZ</span><span class="p">]</span>
            <span class="nv">c0 = </span><span class="k">if</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">yd</span><span class="p">)</span> <span class="k">then</span> <span class="nx">Lerp</span> <span class="nx">c00</span><span class="p">,</span> <span class="nx">c10</span><span class="p">,</span> <span class="nx">yd</span> <span class="k">else</span> <span class="nx">c00</span>
            <span class="nv">c1 = </span><span class="k">if</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">yd</span><span class="p">)</span> <span class="k">then</span> <span class="nx">Lerp</span> <span class="nx">c01</span><span class="p">,</span> <span class="nx">c11</span><span class="p">,</span> <span class="nx">yd</span> <span class="k">else</span> <span class="nx">c01</span>
            <span class="nx">interpolated</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">zd</span><span class="p">)</span> <span class="k">then</span> <span class="nx">Lerp</span> <span class="nx">c0</span><span class="p">,</span> <span class="nx">c1</span><span class="p">,</span> <span class="nx">zd</span> <span class="k">else</span> <span class="nx">c0</span>
    <span class="nx">interpolated</span>

  <span class="nv">process = </span><span class="nf">(gen, func, newHum = &#39;&#39;, newAct = &#39;&#39;, newCld = &#39;&#39;) -&gt;</span>
    <span class="p">[</span><span class="nx">newHum</span><span class="p">,</span> <span class="nx">newAct</span><span class="p">,</span> <span class="nx">newCld</span><span class="p">]</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">gen</span><span class="p">)</span>
    <span class="nv">hum: </span><span class="nx">newHum</span>
    <span class="nv">act: </span><span class="nx">newAct</span>
    <span class="nv">cld: </span><span class="nx">newCld</span>

  <span class="nv">growth = </span><span class="nf">(gen, nAct = &#39;&#39;) -&gt;</span>
    <span class="p">{</span><span class="nx">hum</span><span class="p">,</span> <span class="nx">act</span><span class="p">,</span> <span class="nx">cld</span><span class="p">}</span> <span class="o">=</span> <span class="nx">gen</span>
    <span class="nv">actGrid = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nf">(x, y, z) -&gt;</span> <span class="o">+</span><span class="nx">act</span><span class="p">[</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">@x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">@y</span> <span class="o">+</span> <span class="nx">z</span><span class="p">]))</span>
    <span class="nv">nAct = </span><span class="nx">neighboursAct</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">actGrid</span>
    <span class="nv">newHum = </span><span class="nx">logic</span><span class="p">.</span><span class="o">and</span> <span class="nx">hum</span><span class="p">,</span> <span class="nx">logic</span><span class="p">.</span><span class="o">not</span><span class="p">(</span><span class="nx">act</span><span class="p">)</span>
    <span class="nv">newAct = </span><span class="nx">logic</span><span class="p">.</span><span class="o">and</span> <span class="nx">newHum</span><span class="p">,</span> <span class="nx">nAct</span>
    <span class="nv">newCld = </span><span class="nx">logic</span><span class="p">.</span><span class="o">or</span> <span class="nx">cld</span><span class="p">,</span> <span class="nx">act</span>
    <span class="p">[</span><span class="nx">newHum</span><span class="p">,</span> <span class="nx">newAct</span><span class="p">,</span> <span class="nx">newCld</span><span class="p">]</span>

  <span class="nv">neighboursAct = </span><span class="nf">(grid, str = &#39;&#39;) -&gt;</span>
    <span class="nv">neighbourAct = </span><span class="nf">(grid, x, y, z) -&gt;</span>
      <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">or</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">or</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">or</span>
      <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">or</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">or</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">or</span>
      <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">or</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">or</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">or</span>
      <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">or</span> <span class="nx">grid</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@x</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@y</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@z</span><span class="p">]</span>
          <span class="nx">str</span> <span class="o">+=</span> <span class="k">if</span> <span class="nx">neighbourAct</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">)</span> <span class="k">then</span> <span class="s">&#39;1&#39;</span> <span class="k">else</span> <span class="s">&#39;0&#39;</span>
    <span class="nx">str</span>

  <span class="nv">extinction = </span><span class="nf">(gen, randHum = &#39;&#39;, randAct = &#39;&#39;, randCld = &#39;&#39;) -&gt;</span>
    <span class="p">{</span><span class="nx">hum</span><span class="p">,</span> <span class="nx">act</span><span class="p">,</span> <span class="nx">cld</span><span class="p">}</span> <span class="o">=</span> <span class="nx">gen</span>
    <span class="p">(</span><span class="nx">randHum</span> <span class="o">+=</span> <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nx">P_HUM</span> <span class="k">then</span> <span class="s">&#39;1&#39;</span> <span class="k">else</span> <span class="s">&#39;0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@size</span><span class="p">]</span>
    <span class="p">(</span><span class="nx">randAct</span> <span class="o">+=</span> <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nx">P_HUM</span> <span class="k">then</span> <span class="s">&#39;1&#39;</span> <span class="k">else</span> <span class="s">&#39;0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@size</span><span class="p">]</span>
    <span class="p">(</span><span class="nx">randCld</span> <span class="o">+=</span> <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">P_EXT</span> <span class="k">then</span> <span class="s">&#39;1&#39;</span> <span class="k">else</span> <span class="s">&#39;0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@size</span><span class="p">]</span>
    <span class="nv">newHum = </span><span class="nx">logic</span><span class="p">.</span><span class="o">or</span> <span class="nx">hum</span><span class="p">,</span> <span class="nx">randHum</span>
    <span class="nv">newAct = </span><span class="nx">logic</span><span class="p">.</span><span class="o">or</span> <span class="nx">act</span><span class="p">,</span> <span class="nx">randAct</span>
    <span class="nv">newCld = </span><span class="nx">logic</span><span class="p">.</span><span class="o">and</span> <span class="nx">cld</span><span class="p">,</span> <span class="nx">randCld</span>
    <span class="p">[</span><span class="nx">newHum</span><span class="p">,</span> <span class="nx">newAct</span><span class="p">,</span> <span class="nx">newCld</span><span class="p">]</span>
    
  <span class="nv">wind = </span><span class="nf">(gen, humStr = &#39;&#39;, actStr = &#39;&#39;, cldStr = &#39;&#39;) -&gt;</span>
    <span class="nv">windSpeed = </span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">z</span> <span class="o">*</span> <span class="p">(</span><span class="nx">WIND_SPEED</span> <span class="o">/</span> <span class="nx">@z</span><span class="p">))</span>
    <span class="p">{</span><span class="nx">hum</span><span class="p">,</span> <span class="nx">act</span><span class="p">,</span> <span class="nx">cld</span><span class="p">}</span> <span class="o">=</span> <span class="nx">gen</span>
    <span class="nv">hum = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nf">(x, y, z) -&gt;</span> <span class="o">+</span><span class="nx">hum</span><span class="p">[</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">@x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">@y</span> <span class="o">+</span> <span class="nx">z</span><span class="p">]))</span>
    <span class="nv">act = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nf">(x, y, z) -&gt;</span> <span class="o">+</span><span class="nx">act</span><span class="p">[</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">@x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">@y</span> <span class="o">+</span> <span class="nx">z</span><span class="p">]))</span>
    <span class="nv">cld = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nf">(x, y, z) -&gt;</span> <span class="o">+</span><span class="nx">cld</span><span class="p">[</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">@x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">@y</span> <span class="o">+</span> <span class="nx">z</span><span class="p">]))</span>
    <span class="nv">newHum = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="p">{})</span>
    <span class="nv">newAct = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="p">{})</span>
    <span class="nv">newCld = </span><span class="nx">toGrid</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@x</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@y</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@z</span><span class="p">]</span>
          <span class="nv">windChange = </span><span class="nx">windSpeed</span> <span class="nx">z</span>
          <span class="nx">newHum</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">hum</span><span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">windChange</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">hum</span><span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">windChange</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
          <span class="nx">newAct</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">act</span><span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">windChange</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">act</span><span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">windChange</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
          <span class="nx">newCld</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">cld</span><span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">windChange</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">cld</span><span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">windChange</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@x</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@y</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@z</span><span class="p">]</span>
          <span class="nx">humStr</span> <span class="o">+=</span> <span class="nx">newHum</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span>
          <span class="nx">actStr</span> <span class="o">+=</span> <span class="nx">newAct</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span>
          <span class="nx">cldStr</span> <span class="o">+=</span> <span class="nx">newCld</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">y</span><span class="p">][</span><span class="nx">z</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">humStr</span><span class="p">,</span> <span class="nx">actStr</span><span class="p">,</span> <span class="nx">cldStr</span><span class="p">]</span>

  <span class="nv">getDensity = </span><span class="nf">(clouds, x, y, z) -&gt;</span>
    <span class="nv">weight = </span><span class="nf">(dx, dy, dz) -&gt;</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">((</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">dx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">dy</span> <span class="o">*</span> <span class="nx">dy</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">dz</span> <span class="o">*</span> <span class="nx">dz</span><span class="p">))</span>
    <span class="nv">density = </span><span class="mi">0</span>
    <span class="k">if</span> <span class="nx">clouds</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="k">for</span> <span class="nx">xs</span> <span class="k">in</span> <span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">X</span><span class="p">..</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">X</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">ys</span> <span class="k">in</span> <span class="p">[</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Y</span><span class="p">..</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Y</span><span class="p">]</span>
          <span class="k">for</span> <span class="nx">zs</span> <span class="k">in</span> <span class="p">[</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Z</span><span class="p">..</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Z</span><span class="p">]</span>
            <span class="nv">exists = </span><span class="nx">clouds</span><span class="p">[</span><span class="nx">xs</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">ys</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="nx">zs</span><span class="p">]</span><span class="o">?</span>
            <span class="nx">density</span> <span class="o">+=</span> <span class="p">(</span><span class="k">if</span> <span class="nx">exists</span> <span class="o">and</span> <span class="nx">clouds</span><span class="p">[</span><span class="nx">xs</span><span class="p">][</span><span class="nx">ys</span><span class="p">][</span><span class="nx">zs</span><span class="p">]</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">weight</span><span class="p">(</span><span class="nx">xs</span> <span class="o">-</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">ys</span> <span class="o">-</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">zs</span> <span class="o">-</span> <span class="nx">x</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">density</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nx">density</span> <span class="o">/=</span> <span class="nx">MAX_WEIGHT</span>
      <span class="nx">density</span> <span class="o">/=</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">X</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">SMOOTH</span><span class="p">.</span><span class="nx">Z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="nv">density = </span><span class="nx">density</span>
    <span class="nx">density</span>

<span class="nv">root = </span><span class="nx">exports</span> <span class="o">?</span> <span class="k">this</span>
<span class="nv">root.Clouds = </span><span class="nx">Clouds</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 